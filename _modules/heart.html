

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>heart &mdash; beat 0.1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="beat 0.1 documentation" href="../index.html"/>
        <link rel="up" title="Module code" href="index.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> beat
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../api.html">The <code class="docutils literal"><span class="pre">heart</span></code> Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html#the-config-module">The <code class="docutils literal"><span class="pre">config</span></code> Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html#module-atmcmc">The <code class="docutils literal"><span class="pre">atmcmc</span></code> Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html#module-backend">The <code class="docutils literal"><span class="pre">backend</span></code> Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html#module-models">The <code class="docutils literal"><span class="pre">models</span></code> Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html#module-psgrn">The <code class="docutils literal"><span class="pre">psgrn</span></code> Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html#module-pscmp">The <code class="docutils literal"><span class="pre">pscmp</span></code> Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html#module-covariance">The <code class="docutils literal"><span class="pre">covariance</span></code> Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html#module-theanof">The <code class="docutils literal"><span class="pre">theanof</span></code> Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html#module-utility">The <code class="docutils literal"><span class="pre">utility</span></code> Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html#module-plotting">The <code class="docutils literal"><span class="pre">plotting</span></code> Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html#module-inputf">The <code class="docutils literal"><span class="pre">inputf</span></code> Module</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">beat</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">Module code</a> &raquo;</li>
      
    <li>heart</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for heart</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Core module with functions to calculate Greens Functions and synthetics.</span>
<span class="sd">Also contains main classes for setup specific parameters.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="kn">from</span> <span class="nn">beat</span> <span class="kn">import</span> <span class="n">psgrn</span><span class="p">,</span> <span class="n">pscmp</span><span class="p">,</span> <span class="n">utility</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">num</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pylab</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">from</span> <span class="nn">pyrocko.guts</span> <span class="kn">import</span> <span class="n">Object</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="nn">pyrocko.guts_array</span> <span class="kn">import</span> <span class="n">Array</span>

<span class="kn">from</span> <span class="nn">pyrocko</span> <span class="kn">import</span> <span class="n">crust2x2</span><span class="p">,</span> <span class="n">gf</span><span class="p">,</span> <span class="n">cake</span><span class="p">,</span> <span class="n">orthodrome</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">util</span>
<span class="kn">from</span> <span class="nn">pyrocko.cake</span> <span class="kn">import</span> <span class="n">GradientLayer</span>
<span class="kn">from</span> <span class="nn">pyrocko.fomosto</span> <span class="kn">import</span> <span class="n">qseis</span>
<span class="kn">from</span> <span class="nn">pyrocko.fomosto</span> <span class="kn">import</span> <span class="n">qssp</span>
<span class="c">#from pyrocko.fomosto import qseis2d</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;heart&#39;</span><span class="p">)</span>

<span class="n">c</span> <span class="o">=</span> <span class="mf">299792458.</span>  <span class="c"># [m/s]</span>
<span class="n">km</span> <span class="o">=</span> <span class="mf">1000.</span>
<span class="n">d2r</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span>
<span class="n">err_depth</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">err_velocities</span> <span class="o">=</span> <span class="mf">0.05</span>

<span class="n">lambda_sensors</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;Envisat&#39;</span><span class="p">:</span> <span class="mf">0.056</span><span class="p">,</span>       <span class="c"># needs updating- no ressource file</span>
    <span class="s">&#39;ERS1&#39;</span><span class="p">:</span> <span class="mf">0.05656461471698113</span><span class="p">,</span>
    <span class="s">&#39;ERS2&#39;</span><span class="p">:</span> <span class="mf">0.056</span><span class="p">,</span>          <span class="c"># needs updating</span>
    <span class="s">&#39;JERS&#39;</span><span class="p">:</span> <span class="mf">0.23513133960784313</span><span class="p">,</span>
    <span class="s">&#39;RadarSat2&#39;</span><span class="p">:</span> <span class="mf">0.055465772433</span>
    <span class="p">}</span>


<div class="viewcode-block" id="PickleableTrace"><a class="viewcode-back" href="../api.html#heart.PickleableTrace">[docs]</a><span class="k">class</span> <span class="nc">PickleableTrace</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">Trace</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class build on top of :class:`pyrocko.trace.Trace` to make them pickleable.</span>
<span class="sd">    Obsolete as this has been implemented in pyrocko.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pickled_state</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">PickleableTrace</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__reduce__</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">updated_state</span> <span class="o">=</span> <span class="n">pickled_state</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">,)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">updated_state</span> <span class="o">=</span> <span class="n">pickled_state</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">pickled_state</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pickled_state</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">updated_state</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PickleableTrace</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__setstate__</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>


<div class="viewcode-block" id="RectangularSource"><a class="viewcode-back" href="../api.html#heart.RectangularSource">[docs]</a><span class="k">class</span> <span class="nc">RectangularSource</span><span class="p">(</span><span class="n">gf</span><span class="o">.</span><span class="n">DCSource</span><span class="p">,</span> <span class="n">gf</span><span class="o">.</span><span class="n">seismosizer</span><span class="o">.</span><span class="n">Cloneable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Source for rectangular fault that unifies the necessary different source</span>
<span class="sd">    objects for teleseismic and geodetic computations.</span>
<span class="sd">    Reference point of the depth attribute is the top-center of the fault.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">width</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s">&#39;width of the fault [m]&#39;</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="mf">1.</span> <span class="o">*</span> <span class="n">km</span><span class="p">)</span>
    <span class="n">length</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s">&#39;length of the fault [m]&#39;</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="mf">1.</span> <span class="o">*</span> <span class="n">km</span><span class="p">)</span>
    <span class="n">slip</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s">&#39;slip of the fault [m]&#39;</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
    <span class="n">opening</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s">&#39;opening of the fault [m]&#39;</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="RectangularSource.dipvector"><a class="viewcode-back" href="../api.html#heart.RectangularSource.dipvector">[docs]</a>    <span class="k">def</span> <span class="nf">dipvector</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="n">strike</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate 3 dimensional dip-vector of a planar fault.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dip : scalar, float</span>
<span class="sd">            dip-angle [deg] of the fault</span>
<span class="sd">        strike : scalar, float</span>
<span class="sd">            strike-abgle [deg] of the fault</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`numpy.ndarray`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dip</span> <span class="o">*</span> <span class="n">d2r</span><span class="p">)</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">strike</span> <span class="o">*</span> <span class="n">d2r</span><span class="p">),</span>
                 <span class="o">-</span><span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dip</span> <span class="o">*</span> <span class="n">d2r</span><span class="p">)</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">strike</span> <span class="o">*</span> <span class="n">d2r</span><span class="p">),</span>
                  <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dip</span> <span class="o">*</span> <span class="n">d2r</span><span class="p">)])</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="RectangularSource.strikevector"><a class="viewcode-back" href="../api.html#heart.RectangularSource.strikevector">[docs]</a>    <span class="k">def</span> <span class="nf">strikevector</span><span class="p">(</span><span class="n">strike</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate 3 dimensional strike-vector of a planar fault.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        strike : scalar, float</span>
<span class="sd">            strike-abgle [deg] of the fault</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`numpy.ndarray`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">strike</span> <span class="o">*</span> <span class="n">d2r</span><span class="p">),</span>
                          <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">strike</span> <span class="o">*</span> <span class="n">d2r</span><span class="p">),</span>
                          <span class="mf">0.</span><span class="p">])</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="RectangularSource.center"><a class="viewcode-back" href="../api.html#heart.RectangularSource.center">[docs]</a>    <span class="k">def</span> <span class="nf">center</span><span class="p">(</span><span class="n">top_depth</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">dipvector</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get 3d fault center coordinates.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        top_depth : scalar, float</span>
<span class="sd">            central, top depth [m] of the upper edge of the fault</span>
<span class="sd">        width : scalar, float</span>
<span class="sd">            width [m] of the fault (dip-direction)</span>
<span class="sd">        dipvector : :class:`numpy.ndarray`</span>
<span class="sd">            3d dip-vector of the fault, see also dipvector method</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`numpy.ndarray` with x, y, z coordinates of the center of the</span>
<span class="sd">        fault</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">top_depth</span><span class="p">])</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">width</span> <span class="o">*</span> <span class="n">dipvector</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="RectangularSource.top_depth"><a class="viewcode-back" href="../api.html#heart.RectangularSource.top_depth">[docs]</a>    <span class="k">def</span> <span class="nf">top_depth</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">dipvector</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get top depth of the fault [m]. (Patches method needs input depth to</span>
<span class="sd">        be top_depth.)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        depth : scalar, float</span>
<span class="sd">            depth [m] of the center of the fault</span>
<span class="sd">        width : scalar, float</span>
<span class="sd">            width [m] of the fault (dip-direction)</span>
<span class="sd">        dipvector : :class:`numpy.ndarray`</span>
<span class="sd">            3d dip-vector of the fault, see also dipvector method</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`numpy.ndarray` with x, y, z coordinates of the upper edge of the</span>
<span class="sd">        fault</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">depth</span><span class="p">])</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">width</span> <span class="o">*</span> <span class="n">dipvector</span></div>

<div class="viewcode-block" id="RectangularSource.patches"><a class="viewcode-back" href="../api.html#heart.RectangularSource.patches">[docs]</a>    <span class="k">def</span> <span class="nf">patches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">datatype</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cut source into n by m sub-faults and return n times m</span>
<span class="sd">        :class:`RectangularSource` Objects.</span>
<span class="sd">        Discretization starts at shallow depth going row-wise deeper.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n : int</span>
<span class="sd">            number of patches in length direction (strike)</span>
<span class="sd">        m : int</span>
<span class="sd">            number of patches in width direction (dip)</span>
<span class="sd">        datatype : string</span>
<span class="sd">            &#39;geodetic&#39; or &#39;seismic&#39; determines the source to be returned</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`pscmp.PsCmpRectangularSource` or</span>
<span class="sd">        :class:`pyrocko.gf.seismosizer.RectangularSource` depending on datatype</span>
<span class="sd">        depth is being updated from top_depth to center_depth.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="n">patches</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">dip_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dipvector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dip</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">strike</span><span class="p">)</span>
        <span class="n">strike_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strikevector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strike</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="n">sub_center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">dip_vec</span><span class="p">)</span> <span class="o">+</span> \
                            <span class="n">strike_vec</span> <span class="o">*</span> <span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">length</span><span class="p">)</span> <span class="o">+</span> \
                            <span class="n">dip_vec</span> <span class="o">*</span> <span class="p">((</span><span class="n">j</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">width</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s">&#39;seismic&#39;</span><span class="p">:</span>
                    <span class="n">patch</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">RectangularSource</span><span class="p">(</span>
                        <span class="n">lat</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">),</span>
                        <span class="n">lon</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">),</span>
                        <span class="n">east_shift</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">sub_center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">east_shift</span><span class="p">),</span>
                        <span class="n">north_shift</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">sub_center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">north_shift</span><span class="p">),</span>
                        <span class="n">depth</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">sub_center</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                        <span class="n">strike</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">strike</span><span class="p">,</span> <span class="n">dip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dip</span><span class="p">,</span> <span class="n">rake</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rake</span><span class="p">,</span>
                        <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">stf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stf</span><span class="p">,</span>
                        <span class="n">time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">slip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slip</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s">&#39;geodetic&#39;</span><span class="p">:</span>
                    <span class="n">patch</span> <span class="o">=</span> <span class="n">pscmp</span><span class="o">.</span><span class="n">PsCmpRectangularSource</span><span class="p">(</span>
                        <span class="n">lat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span>
                        <span class="n">lon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span>
                        <span class="n">east_shift</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">sub_center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">east_shift</span><span class="p">),</span>
                        <span class="n">north_shift</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">sub_center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">north_shift</span><span class="p">),</span>
                        <span class="n">depth</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">sub_center</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                        <span class="n">strike</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">strike</span><span class="p">,</span> <span class="n">dip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dip</span><span class="p">,</span> <span class="n">rake</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rake</span><span class="p">,</span>
                        <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">slip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slip</span><span class="p">,</span>
                        <span class="n">opening</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opening</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                        <span class="s">&quot;Datatype not supported either: &#39;seismic/geodetic&#39;&quot;</span><span class="p">)</span>

                <span class="n">patches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">patches</span></div></div>


<div class="viewcode-block" id="adjust_fault_reference"><a class="viewcode-back" href="../api.html#heart.adjust_fault_reference">[docs]</a><span class="k">def</span> <span class="nf">adjust_fault_reference</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">input_depth</span><span class="o">=</span><span class="s">&#39;top&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adjusts source depth and east/north-shifts variables of fault according to</span>
<span class="sd">    input_depth mode &#39;top/center&#39;.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    source : :class:`RectangularSource` or :class:`pscmp.RectangularSource` or</span>
<span class="sd">        :class:`pyrocko.gf.seismosizer.RectangularSource`</span>
<span class="sd">    input_depth : string</span>
<span class="sd">        if &#39;top&#39; the depth in the source is interpreted as top depth</span>
<span class="sd">        if &#39;center&#39; the depth in the source is interpreted as center depth</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Updated input source object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">RF</span> <span class="o">=</span> <span class="n">RectangularSource</span>

    <span class="n">dip_vec</span> <span class="o">=</span> <span class="n">RF</span><span class="o">.</span><span class="n">dipvector</span><span class="p">(</span><span class="n">dip</span><span class="o">=</span><span class="n">source</span><span class="o">.</span><span class="n">dip</span><span class="p">,</span> <span class="n">strike</span><span class="o">=</span><span class="n">source</span><span class="o">.</span><span class="n">strike</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">input_depth</span> <span class="o">==</span> <span class="s">&#39;top&#39;</span><span class="p">:</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">RF</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">top_depth</span><span class="o">=</span><span class="n">source</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span>
                       <span class="n">width</span><span class="o">=</span><span class="n">source</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
                       <span class="n">dipvector</span><span class="o">=</span><span class="n">dip_vec</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">input_depth</span> <span class="o">==</span> <span class="s">&#39;center&#39;</span><span class="p">:</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">depth</span><span class="p">])</span>

    <span class="n">source</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">east_shift</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">source</span><span class="o">.</span><span class="n">east_shift</span><span class="p">),</span>
                  <span class="n">north_shift</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">source</span><span class="o">.</span><span class="n">north_shift</span><span class="p">),</span>
                  <span class="n">depth</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span></div>


<div class="viewcode-block" id="log_determinant"><a class="viewcode-back" href="../api.html#heart.log_determinant">[docs]</a><span class="k">def</span> <span class="nf">log_determinant</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the natural logarithm of a determinant of the given matrix &#39;</span>
<span class="sd">    according to the properties of a triangular matrix.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    A : n x n :class:`numpy.ndarray`</span>
<span class="sd">    inverse : boolean</span>
<span class="sd">        If true calculates the log determinant of the inverse of the colesky</span>
<span class="sd">        decomposition, which is equvalent to taking the determinant of the</span>
<span class="sd">        inverse of the matrix.</span>

<span class="sd">        L.T* L = R           inverse=False</span>
<span class="sd">        L-1*(L-1)T = R-1     inverse=True</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float logarithm of the determinant of the input Matrix A</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cholesky</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">inverse</span><span class="p">:</span>
        <span class="n">cholesky</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cholesky</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cholesky</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>


<div class="viewcode-block" id="Covariance"><a class="viewcode-back" href="../api.html#heart.Covariance">[docs]</a><span class="k">class</span> <span class="nc">Covariance</span><span class="p">(</span><span class="n">Object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Covariance of an observation. Holds data and model prediction uncertainties</span>
<span class="sd">    for one observation object.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s">&#39;Data covariance matrix&#39;</span><span class="p">,</span>
                    <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">pred_g</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s">&#39;Model prediction covariance matrix, fault geometry&#39;</span><span class="p">,</span>
                    <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">pred_v</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s">&#39;Model prediction covariance matrix, velocity model&#39;</span><span class="p">,</span>
                    <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">p_total</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_g</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pred_g</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_v</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pred_v</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_g</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_v</span>

<div class="viewcode-block" id="Covariance.get_inverse"><a class="viewcode-back" href="../api.html#heart.Covariance.get_inverse">[docs]</a>    <span class="k">def</span> <span class="nf">get_inverse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add and invert ALL uncertainty covariance Matrices.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_total</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="Covariance.get_inverse_p"><a class="viewcode-back" href="../api.html#heart.Covariance.get_inverse_p">[docs]</a>    <span class="k">def</span> <span class="nf">get_inverse_p</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add and invert different MODEL uncertainty covariance Matrices.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_total</span><span class="p">)</span></div>

<div class="viewcode-block" id="Covariance.get_inverse_d"><a class="viewcode-back" href="../api.html#heart.Covariance.get_inverse_d">[docs]</a>    <span class="k">def</span> <span class="nf">get_inverse_d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Invert DATA covariance Matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">log_norm_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the normalisation factor of the posterior pdf.</span>
<span class="sd">        Following Duputel et al. 2014</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_total</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">ldet_x</span> <span class="o">=</span> <span class="n">log_determinant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_total</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ldet_x</span> <span class="o">=</span> <span class="n">log_determinant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">+</span> <span class="n">ldet_x</span></div>


<div class="viewcode-block" id="TeleseismicTarget"><a class="viewcode-back" href="../api.html#heart.TeleseismicTarget">[docs]</a><span class="k">class</span> <span class="nc">TeleseismicTarget</span><span class="p">(</span><span class="n">gf</span><span class="o">.</span><span class="n">Target</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extension to :class:`pyrocko.gf.seismpsizer.Target` to have </span>
<span class="sd">    :class:`Covariance` as an attribute.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">covariance</span> <span class="o">=</span> <span class="n">Covariance</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="n">Covariance</span><span class="o">.</span><span class="n">D</span><span class="p">(),</span>
        <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;:py:class:`Covariance` that holds data&#39;</span>
             <span class="s">&#39;and model prediction covariance matrixes&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ArrivalTaper"><a class="viewcode-back" href="../api.html#heart.ArrivalTaper">[docs]</a><span class="k">class</span> <span class="nc">ArrivalTaper</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">Taper</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cosine arrival Taper.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">15.</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s">&#39;start of fading in; [s] w.r.t. phase arrival&#39;</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s">&#39;end of fading in; [s] w.r.t. phase arrival&#39;</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">50.</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s">&#39;start of fading in; [s] w.r.t. phase arrival&#39;</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">55.</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s">&#39;end of fading in; [s] w.r.t phase arrival&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Filter"><a class="viewcode-back" href="../api.html#heart.Filter">[docs]</a><span class="k">class</span> <span class="nc">Filter</span><span class="p">(</span><span class="n">Object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter object defining frequency range of traces after filtering</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">lower_corner</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Lower corner frequency&#39;</span><span class="p">)</span>
    <span class="n">upper_corner</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Upper corner frequency&#39;</span><span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">Int</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;order of filter, the higher the steeper&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Parameter"><a class="viewcode-back" href="../api.html#heart.Parameter">[docs]</a><span class="k">class</span> <span class="nc">Parameter</span><span class="p">(</span><span class="n">Object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Optimization parameter determines the bounds of the search space.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s">&#39;lon&#39;</span><span class="p">)</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s">&#39;Uniform&#39;</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s">&#39;Type of prior distribution to use. Options:&#39;</span>
                         <span class="s">&#39; &quot;Uniform&quot;, ...&#39;</span><span class="p">)</span>
    <span class="n">lower</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,),</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span>
                    <span class="n">serialize_as</span><span class="o">=</span><span class="s">&#39;list&#39;</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]))</span>
    <span class="n">upper</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,),</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span>
                    <span class="n">serialize_as</span><span class="o">=</span><span class="s">&#39;list&#39;</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]))</span>
    <span class="n">testvalue</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,),</span>
                        <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span>
                        <span class="n">serialize_as</span><span class="o">=</span><span class="s">&#39;list&#39;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimension</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">testvalue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">or</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">testvalue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;the testvalue of parameter &quot;</span><span class="si">%s</span><span class="s">&quot; has to be&#39;</span>
                        <span class="s">&#39;within the upper and lower bounds&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dimension</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="o">.</span><span class="n">size</span>

    <span class="k">def</span> <span class="nf">bound_to_array</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">testval</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="p">],</span>
                         <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">)</span></div>


<div class="viewcode-block" id="IFG"><a class="viewcode-back" href="../api.html#heart.IFG">[docs]</a><span class="k">class</span> <span class="nc">IFG</span><span class="p">(</span><span class="n">Object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Interferogram class as a dataset in the optimization.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">track</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s">&#39;A&#39;</span><span class="p">)</span>
    <span class="n">master</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&#39;Acquisition time of master image YYYY-MM-DD&#39;</span><span class="p">)</span>
    <span class="n">slave</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&#39;Acquisition time of slave image YYYY-MM-DD&#39;</span><span class="p">)</span>
    <span class="n">amplitude</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">wrapped_phase</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">incidence</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">heading</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">los_vector</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">utmn</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">utme</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">lats</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">lons</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">satellite</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s">&#39;Envisat&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;IFG Acquisition Track: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">track</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s">&#39;  timerange: </span><span class="si">%s</span><span class="s"> - </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slave</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s">&#39;  number of pixels: </span><span class="si">%i</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">lats</span><span class="o">.</span><span class="n">size</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">wavelength</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">lambda_sensors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">satellite</span><span class="p">]</span>

<div class="viewcode-block" id="IFG.update_los_vector"><a class="viewcode-back" href="../api.html#heart.IFG.update_los_vector">[docs]</a>    <span class="k">def</span> <span class="nf">update_los_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate LOS vector for given attributes incidence and heading angles.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`numpy.ndarray` (n_points, 3)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">incidence</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Incidence and Heading need to be provided!&#39;</span><span class="p">)</span>

        <span class="n">Su</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">incidence</span><span class="p">))</span>
        <span class="n">Sn</span> <span class="o">=</span> <span class="o">-</span> <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">incidence</span><span class="p">))</span> <span class="o">*</span> \
             <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heading</span> <span class="o">-</span> <span class="mi">270</span><span class="p">))</span>
        <span class="n">Se</span> <span class="o">=</span> <span class="o">-</span> <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">incidence</span><span class="p">))</span> <span class="o">*</span> \
             <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heading</span> <span class="o">-</span> <span class="mi">270</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">los_vector</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Sn</span><span class="p">,</span> <span class="n">Se</span><span class="p">,</span> <span class="n">Su</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">los_vector</span></div></div>


<div class="viewcode-block" id="DiffIFG"><a class="viewcode-back" href="../api.html#heart.DiffIFG">[docs]</a><span class="k">class</span> <span class="nc">DiffIFG</span><span class="p">(</span><span class="n">IFG</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Differential Interferogram class as geodetic target for the calculation</span>
<span class="sd">    of synthetics and container for SAR data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">unwrapped_phase</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">coherence</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">reference_point</span> <span class="o">=</span> <span class="n">Tuple</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(),</span> <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">reference_value</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">displacement</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">covariance</span> <span class="o">=</span> <span class="n">Covariance</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;:py:class:`Covariance` that holds data&#39;</span>
             <span class="s">&#39;and model prediction covariance matrixes&#39;</span><span class="p">)</span>
    <span class="n">odw</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,),</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Overlapping data weights, additional weight factor to the&#39;</span>
             <span class="s">&#39;dataset for overlaps with other datasets&#39;</span><span class="p">,</span>
        <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<div class="viewcode-block" id="DiffIFG.plot"><a class="viewcode-back" href="../api.html#heart.DiffIFG.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point_size</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Very simple scatter plot of given attribute for fast inspections.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        point_size : int</span>
<span class="sd">            determines the size of the scatter plot points</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c">#colim = num.max([disp.max(), num.abs(disp.min())])</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">()</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lons</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lats</span><span class="p">,</span> <span class="n">point_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">displacement</span><span class="p">,</span>
            <span class="n">edgecolors</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Displacements [m] </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">track</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="init_targets"><a class="viewcode-back" href="../api.html#heart.init_targets">[docs]</a><span class="k">def</span> <span class="nf">init_targets</span><span class="p">(</span><span class="n">stations</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;T&#39;</span><span class="p">,</span> <span class="s">&#39;Z&#39;</span><span class="p">],</span> <span class="n">sample_rate</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                 <span class="n">crust_inds</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;multilinear&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initiate a list of target objects given a list of indexes to the</span>
<span class="sd">    respective GF store velocity model variation index (crust_inds).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    stations : List of :class:`pyrocko.model.Station`</span>
<span class="sd">        List of station objects for which the targets are being initialised</span>
<span class="sd">    channels : List of str</span>
<span class="sd">        Components of the traces to be optimized for if rotated:</span>
<span class="sd">        T - transversal, Z - vertical, R - radial</span>
<span class="sd">        If not rotated:</span>
<span class="sd">        E - East, N- North, U - Up (Vertical)</span>
<span class="sd">    sample_rate : scalar, float</span>
<span class="sd">        sample rate [Hz] of the Greens Functions to use</span>
<span class="sd">    crust_inds : List of int</span>
<span class="sd">        Indexes of different velocity model realisations, 0 - reference model</span>
<span class="sd">    interpolation : str</span>
<span class="sd">        Method of interpolation for the Greens Functions, can be &#39;multilinear&#39;</span>
<span class="sd">        or &#39;nearest_neighbor&#39;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List of :class:`pyrocko.gf.seismosizer.Target`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="n">TeleseismicTarget</span><span class="p">(</span>
        <span class="n">quantity</span><span class="o">=</span><span class="s">&#39;displacement&#39;</span><span class="p">,</span>
        <span class="n">codes</span><span class="o">=</span><span class="p">(</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_num</span><span class="p">]</span><span class="o">.</span><span class="n">network</span><span class="p">,</span>
                 <span class="n">stations</span><span class="p">[</span><span class="n">sta_num</span><span class="p">]</span><span class="o">.</span><span class="n">station</span><span class="p">,</span>
                 <span class="s">&#39;</span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">crust_ind</span><span class="p">,</span> <span class="n">channel</span><span class="p">),</span>  <span class="c"># n, s, l, c</span>
        <span class="n">lat</span><span class="o">=</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_num</span><span class="p">]</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span>
        <span class="n">lon</span><span class="o">=</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_num</span><span class="p">]</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span>
        <span class="n">azimuth</span><span class="o">=</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_num</span><span class="p">]</span><span class="o">.</span><span class="n">get_channel</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span><span class="o">.</span><span class="n">azimuth</span><span class="p">,</span>
        <span class="n">dip</span><span class="o">=</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_num</span><span class="p">]</span><span class="o">.</span><span class="n">get_channel</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span><span class="o">.</span><span class="n">dip</span><span class="p">,</span>
        <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span><span class="p">,</span>
        <span class="n">store_id</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">_ak135_</span><span class="si">%.3f</span><span class="s">Hz_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_num</span><span class="p">]</span><span class="o">.</span><span class="n">station</span><span class="p">,</span>
                                                <span class="n">sample_rate</span><span class="p">,</span> <span class="n">crust_ind</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channels</span>
            <span class="k">for</span> <span class="n">crust_ind</span> <span class="ow">in</span> <span class="n">crust_inds</span>
                <span class="k">for</span> <span class="n">sta_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stations</span><span class="p">))]</span>

    <span class="k">return</span> <span class="n">targets</span></div>


<div class="viewcode-block" id="vary_model"><a class="viewcode-back" href="../api.html#heart.vary_model">[docs]</a><span class="k">def</span> <span class="nf">vary_model</span><span class="p">(</span><span class="n">earthmod</span><span class="p">,</span> <span class="n">err_depth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">err_velocities</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">depth_limit_variation</span><span class="o">=</span><span class="mi">600</span> <span class="o">*</span> <span class="n">km</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vary depths and velocities in the given source model by Gaussians with</span>
<span class="sd">    given 2-sigma errors [percent]. Ensures increasing velocity with depth.</span>
<span class="sd">    Stops variating the input model at the given depth_limit_variation [m].</span>
<span class="sd">    Mantle discontinuity uncertainties are hardcoded based on</span>
<span class="sd">    Mooney et al. 1981 and Woodward et al.1991</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    earthmod : :class:`pyrocko.cake.LayeredModel`</span>
<span class="sd">        Earthmodel defining layers, depth, velocities, densities</span>
<span class="sd">    err_depth : scalar, float</span>
<span class="sd">        2 sigma error in percent of the depth for the respective layers</span>
<span class="sd">    err_velocities : scalar, float</span>
<span class="sd">        2 sigma error in percent of the velocities for the respective layers</span>
<span class="sd">    depth_limit_variations : scalar, float</span>
<span class="sd">        depth threshold [m], layers with depth &gt; than this are not varied</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Varied Earthmodel : :class:`pyrocko.cake.LayeredModel`</span>
<span class="sd">    Cost : int</span>
<span class="sd">        Counts repetitions of cycles to ensure increasing layer velocity,</span>
<span class="sd">        unlikely velocities have high Cost</span>
<span class="sd">        Cost of up to 20 are ok for crustal profiles.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">new_earthmod</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">earthmod</span><span class="p">)</span>
    <span class="n">layers</span> <span class="o">=</span> <span class="n">new_earthmod</span><span class="o">.</span><span class="n">layers</span><span class="p">()</span>

    <span class="n">last_l</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">deltaz</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c"># uncertainties in discontinuity depth after Shearer 1991</span>
    <span class="n">discont_unc</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;410&#39;</span><span class="p">:</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">km</span><span class="p">,</span>
                   <span class="s">&#39;520&#39;</span><span class="p">:</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">km</span><span class="p">,</span>
                   <span class="s">&#39;660&#39;</span><span class="p">:</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">km</span><span class="p">}</span>

    <span class="c"># uncertainties in velocity for upper and lower mantle from Woodward 1991</span>
    <span class="n">mantle_vel_unc</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;200&#39;</span><span class="p">:</span> <span class="mf">0.02</span><span class="p">,</span>     <span class="c"># above 200</span>
                      <span class="s">&#39;400&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">}</span>     <span class="c"># above 400</span>

    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
        <span class="c"># stop if depth_limit_variation is reached</span>
        <span class="k">if</span> <span class="n">depth_limit_variation</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">ztop</span> <span class="o">&gt;=</span> <span class="n">depth_limit_variation</span><span class="p">:</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">ztop</span> <span class="o">=</span> <span class="n">last_l</span><span class="o">.</span><span class="n">zbot</span>
                <span class="c"># assign large cost if previous layer has higher velocity</span>
                <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vp</span> <span class="o">&lt;</span> <span class="n">last_l</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vp</span> <span class="ow">or</span> \
                   <span class="n">layer</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vp</span> <span class="o">&gt;</span> <span class="n">layer</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vp</span><span class="p">:</span>
                    <span class="n">cost</span> <span class="o">=</span> <span class="mi">1000</span>
                <span class="c"># assign large cost if layer bottom depth smaller than top</span>
                <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">zbot</span> <span class="o">&lt;</span> <span class="n">layer</span><span class="o">.</span><span class="n">ztop</span><span class="p">:</span>
                    <span class="n">cost</span> <span class="o">=</span> <span class="mi">1000</span>
                <span class="k">break</span>
        <span class="n">repeat</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">repeat</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="c"># vary layer velocity</span>
            <span class="c"># check for layer depth and use hardcoded uncertainties</span>
            <span class="k">for</span> <span class="n">l_depth</span><span class="p">,</span> <span class="n">vel_unc</span> <span class="ow">in</span> <span class="n">mantle_vel_unc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">l_depth</span><span class="p">)</span> <span class="o">*</span> <span class="n">km</span> <span class="o">&lt;</span> <span class="n">layer</span><span class="o">.</span><span class="n">ztop</span><span class="p">:</span>
                    <span class="n">err_velocities</span> <span class="o">=</span> <span class="n">vel_unc</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Velocity error: </span><span class="si">%f</span><span class="s"> &#39;</span><span class="p">,</span> <span class="n">err_velocities</span><span class="p">)</span>

            <span class="n">deltavp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span>
                        <span class="mi">0</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vp</span> <span class="o">*</span> <span class="n">err_velocities</span> <span class="o">/</span> <span class="mf">3.</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">ztop</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vp</span> <span class="o">+=</span> <span class="n">deltavp</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vs</span> <span class="o">+=</span> <span class="p">(</span><span class="n">deltavp</span> <span class="o">/</span> <span class="n">layer</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vp_vs_ratio</span><span class="p">())</span>

            <span class="c"># ensure increasing velocity with depth</span>
            <span class="k">if</span> <span class="n">last_l</span><span class="p">:</span>
                <span class="c"># gradient layer without interface</span>
                <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vp</span> <span class="o">==</span> <span class="n">last_l</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vp</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vp</span> <span class="o">+</span> <span class="n">deltavp</span> <span class="o">&lt;</span> <span class="n">layer</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vp</span><span class="p">:</span>
                        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">layer</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vp</span> <span class="o">+=</span> <span class="n">deltavp</span>
                        <span class="n">layer</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vs</span> <span class="o">+=</span> <span class="p">(</span><span class="n">deltavp</span> <span class="o">/</span>
                                                <span class="n">layer</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vp_vs_ratio</span><span class="p">())</span>
                        <span class="n">repeat</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">cost</span> <span class="o">+=</span> <span class="n">count</span>
                <span class="k">elif</span> <span class="n">layer</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vp</span> <span class="o">+</span> <span class="n">deltavp</span> <span class="o">&lt;</span> <span class="n">last_l</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vp</span><span class="p">:</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">layer</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vp</span> <span class="o">+=</span> <span class="n">deltavp</span>
                    <span class="n">layer</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vs</span> <span class="o">+=</span> <span class="p">(</span><span class="n">deltavp</span> <span class="o">/</span> <span class="n">layer</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vp_vs_ratio</span><span class="p">())</span>

                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">GradientLayer</span><span class="p">):</span>
                        <span class="n">layer</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vp</span> <span class="o">+=</span> <span class="n">deltavp</span>
                        <span class="n">layer</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vs</span> <span class="o">+=</span> <span class="p">(</span><span class="n">deltavp</span> <span class="o">/</span> <span class="n">layer</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vp_vs_ratio</span><span class="p">())</span>
                    <span class="n">repeat</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">cost</span> <span class="o">+=</span> <span class="n">count</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">repeat</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c"># vary layer depth</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">ztop</span> <span class="o">+=</span> <span class="n">deltaz</span>
        <span class="n">repeat</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c"># use hard coded uncertainties for mantle discontinuities</span>
        <span class="k">if</span> <span class="s">&#39;</span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">zbot</span> <span class="o">/</span> <span class="n">km</span><span class="p">)</span> <span class="ow">in</span> <span class="n">discont_unc</span><span class="p">:</span>
            <span class="n">factor_d</span> <span class="o">=</span> <span class="n">discont_unc</span><span class="p">[</span><span class="s">&#39;</span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">zbot</span> <span class="o">/</span> <span class="n">km</span><span class="p">)]</span> <span class="o">/</span> <span class="n">layer</span><span class="o">.</span><span class="n">zbot</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">factor_d</span> <span class="o">=</span> <span class="n">err_depth</span>

        <span class="k">while</span> <span class="n">repeat</span><span class="p">:</span>
            <span class="c"># ensure that bottom of layer is not shallower than the top</span>
            <span class="n">deltaz</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span>
                       <span class="mi">0</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">zbot</span> <span class="o">*</span> <span class="n">factor_d</span> <span class="o">/</span> <span class="mf">3.</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>  <span class="c"># 3 sigma</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">zbot</span> <span class="o">+=</span> <span class="n">deltaz</span>
            <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">zbot</span> <span class="o">&lt;</span> <span class="n">layer</span><span class="o">.</span><span class="n">ztop</span><span class="p">:</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">zbot</span> <span class="o">-=</span> <span class="n">deltaz</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">repeat</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">cost</span> <span class="o">+=</span> <span class="n">count</span>

        <span class="n">last_l</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_earthmod</span><span class="p">,</span> <span class="n">cost</span></div>


<div class="viewcode-block" id="ensemble_earthmodel"><a class="viewcode-back" href="../api.html#heart.ensemble_earthmodel">[docs]</a><span class="k">def</span> <span class="nf">ensemble_earthmodel</span><span class="p">(</span><span class="n">ref_earthmod</span><span class="p">,</span> <span class="n">num_vary</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">err_depth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                        <span class="n">err_velocities</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">depth_limit_variation</span><span class="o">=</span><span class="mi">600</span> <span class="o">*</span> <span class="n">km</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create ensemble of earthmodels that vary around a given input earth model</span>
<span class="sd">    by a Gaussian of 2 sigma (in Percent 0.1 = 10%) for the depth layers</span>
<span class="sd">    and for the p and s wave velocities. Vp / Vs is kept unchanged</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ref_earthmod : :class:`pyrocko.cake.LayeredModel`</span>
<span class="sd">        Reference earthmodel defining layers, depth, velocities, densities</span>
<span class="sd">    num_vary : scalar, int</span>
<span class="sd">        Number of variation realisations</span>
<span class="sd">    err_depth : scalar, float</span>
<span class="sd">        2 sigma error in percent of the depth for the respective layers</span>
<span class="sd">    err_velocities : scalar, float</span>
<span class="sd">        2 sigma error in percent of the velocities for the respective layers</span>
<span class="sd">    depth_limit_variations : scalar, float</span>
<span class="sd">        depth threshold [m], layers with depth &gt; than this are not varied</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List of Varied Earthmodels :class:`pyrocko.cake.LayeredModel`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">earthmods</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_vary</span><span class="p">:</span>
        <span class="n">new_model</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="n">vary_model</span><span class="p">(</span>
            <span class="n">ref_earthmod</span><span class="p">,</span>
            <span class="n">err_depth</span><span class="p">,</span>
            <span class="n">err_velocities</span><span class="p">,</span>
            <span class="n">depth_limit_variation</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cost</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Skipped unlikely model </span><span class="si">%f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">cost</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">earthmods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_model</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">earthmods</span></div>


<div class="viewcode-block" id="seis_construct_gf"><a class="viewcode-back" href="../api.html#heart.seis_construct_gf">[docs]</a><span class="k">def</span> <span class="nf">seis_construct_gf</span><span class="p">(</span><span class="n">station</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">store_superdir</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="s">&#39;qssp&#39;</span><span class="p">,</span>
        <span class="n">source_depth_min</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">source_depth_max</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span> <span class="n">source_depth_spacing</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
        <span class="n">source_distance_radius</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span> <span class="n">source_distance_spacing</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
        <span class="n">sample_rate</span><span class="o">=</span><span class="mf">2.</span><span class="p">,</span> <span class="n">depth_limit_variation</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span>
        <span class="n">earth_model</span><span class="o">=</span><span class="s">&#39;ak135-f-average.m&#39;</span><span class="p">,</span> <span class="n">crust_ind</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">execute</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">rm_gfs</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nworkers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">use_crust2</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">replace_water</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">custom_velocity_model</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate seismic Greens Functions (GFs) and create a repository &#39;store&#39;</span>
<span class="sd">    that is being used later on repeatetly to calculate the synthetic</span>
<span class="sd">    waveforms.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    station : :class:`pyrocko.model.Station`</span>
<span class="sd">        Station object that defines the distance from the event for which the</span>
<span class="sd">        GFs are being calculated</span>
<span class="sd">    event : :class:`pyrocko.model.Event`</span>
<span class="sd">        The event is used as a reference point for all the calculations</span>
<span class="sd">        According to the its location the earth model is being built</span>
<span class="sd">    store_superdir : str</span>
<span class="sd">        Path to the main directory where all the GF stores are stored</span>
<span class="sd">    code : str</span>
<span class="sd">        Modeling code to use for the calculation of waveforms.</span>
<span class="sd">        implemented so far: `qseis`, `qssp`, coming soon `qseis2d`</span>
<span class="sd">        QSSP does calculations on a circle thus it is recommended to use it for</span>
<span class="sd">        teleseismic distances. QSEIS does calculations on a cylinder and is</span>
<span class="sd">        more accurate for near-field seismic waveforms, QSEIS2d is a</span>
<span class="sd">        significantly, computationally more efficient version of QSEIS, outputs</span>
<span class="sd">        are almost identical</span>
<span class="sd">    source_distance_min : scalar, float</span>
<span class="sd">        Lower bound [km] for the source-distance grid of GFs to calculate</span>
<span class="sd">    source_distance_max : scalar, float</span>
<span class="sd">        Upper bound [km] for the source-distance grid of GFs to calculate</span>
<span class="sd">    source_distance_spacing : scalar, float</span>
<span class="sd">        Spacing [km] for the source-distance grid of GFs to calculate</span>
<span class="sd">    source_depth_min : scalar, float</span>
<span class="sd">        Lower bound [km] for the source-depth grid of GFs to calculate</span>
<span class="sd">    source_depth_max : scalar, float</span>
<span class="sd">        Upper bound [km] for the source-depth grid of GFs to calculate</span>
<span class="sd">    source_depth_spacing : scalar, float</span>
<span class="sd">        Spacing [km] for the source-depth grid of GFs to calculate</span>
<span class="sd">    sample_rate : scalar, float</span>
<span class="sd">        Temporal sampling rate [Hz] of seismic waveforms</span>
<span class="sd">    crust_ind : int</span>
<span class="sd">        Index to set to the Greens Function store, 0 is reference store</span>
<span class="sd">        indexes &gt; 0 use reference model and vary its parameters by a Gaussian</span>
<span class="sd">    depth_limit_variation : scalar, float</span>
<span class="sd">        depth threshold [m], layers with depth &gt; than this limit are not varied</span>
<span class="sd">    earth_model : str</span>
<span class="sd">        Name of the base earth model to be used, check</span>
<span class="sd">        :func:`pyrocko.cake.builtin_models` for alternatives,</span>
<span class="sd">        default ak135 with medium resolution</span>
<span class="sd">    nworkers : int</span>
<span class="sd">        Number of processors to use for computations</span>
<span class="sd">    rm_gfs : boolean</span>
<span class="sd">        Valid if qssp or qseis2d are being used, remove the intermediate </span>
<span class="sd">        files after finishing the computation</span>
<span class="sd">    replace_water : boolean</span>
<span class="sd">        Flag to remove water layers from the crust2.0 profile</span>
<span class="sd">    use_crust2 : boolean</span>
<span class="sd">        Flag to use the crust2.0 model for the crustal earth model</span>
<span class="sd">    custom_velocity_model : :class:`pyrocko.cake.LayeredModel`</span>
<span class="sd">        If the implemented velocity models should not be used, a custom</span>
<span class="sd">        velocity model can be given here</span>
<span class="sd">    execute : boolean</span>
<span class="sd">        Flag to execute the calculation, if False just setup tested</span>
<span class="sd">    force : boolean</span>
<span class="sd">        Flag to overwrite existing GF stores</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># calculate distance to station [m]</span>
    <span class="n">distance</span> <span class="o">=</span> <span class="n">orthodrome</span><span class="o">.</span><span class="n">distance_accurate50m</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">station</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Station </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">station</span><span class="o">.</span><span class="n">station</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;---------------------&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">use_crust2</span><span class="p">:</span>
        <span class="c"># load velocity profile from CRUST2x2 and check for water layer</span>
        <span class="n">profile_station</span> <span class="o">=</span> <span class="n">crust2x2</span><span class="o">.</span><span class="n">get_profile</span><span class="p">(</span><span class="n">station</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">station</span><span class="o">.</span><span class="n">lon</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">replace_water</span><span class="p">:</span>
            <span class="n">thickness_lwater</span> <span class="o">=</span> <span class="n">profile_station</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="n">crust2x2</span><span class="o">.</span><span class="n">LWATER</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">thickness_lwater</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Water layer </span><span class="si">%f</span><span class="s"> in CRUST model!&#39;</span>
                    <span class="s">&#39; Remove and add to lower crust&#39;</span> <span class="o">%</span> <span class="n">thickness_lwater</span><span class="p">)</span>
                <span class="n">thickness_llowercrust</span> <span class="o">=</span> <span class="n">profile_station</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span>
                                                <span class="n">crust2x2</span><span class="o">.</span><span class="n">LLOWERCRUST</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">thickness_lsoftsed</span> <span class="o">=</span> <span class="n">profile_station</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span>
                    <span class="n">crust2x2</span><span class="o">.</span><span class="n">LSOFTSED</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">profile_station</span><span class="o">.</span><span class="n">set_layer_thickness</span><span class="p">(</span><span class="n">crust2x2</span><span class="o">.</span><span class="n">LWATER</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="n">profile_station</span><span class="o">.</span><span class="n">set_layer_thickness</span><span class="p">(</span><span class="n">crust2x2</span><span class="o">.</span><span class="n">LSOFTSED</span><span class="p">,</span>
                        <span class="n">num</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">thickness_lsoftsed</span> <span class="o">/</span> <span class="mi">3</span><span class="p">))</span>
                <span class="n">profile_station</span><span class="o">.</span><span class="n">set_layer_thickness</span><span class="p">(</span><span class="n">crust2x2</span><span class="o">.</span><span class="n">LLOWERCRUST</span><span class="p">,</span>
                        <span class="n">thickness_llowercrust</span> <span class="o">+</span> \
                        <span class="n">thickness_lwater</span> <span class="o">+</span> \
                        <span class="p">(</span><span class="n">thickness_lsoftsed</span> <span class="o">-</span> <span class="n">num</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">thickness_lsoftsed</span> <span class="o">/</span> <span class="mi">3</span><span class="p">))</span>
                        <span class="p">)</span>
                <span class="n">profile_station</span><span class="o">.</span><span class="n">_elevation</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;New Lower crust layer thickness </span><span class="si">%f</span><span class="s">&#39;</span> <span class="o">%</span> \
                    <span class="n">profile_station</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="n">crust2x2</span><span class="o">.</span><span class="n">LLOWERCRUST</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">profile_event</span> <span class="o">=</span> <span class="n">crust2x2</span><span class="o">.</span><span class="n">get_profile</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">lon</span><span class="p">)</span>

        <span class="c">#extract model for source region</span>
        <span class="n">source_model</span> <span class="o">=</span> <span class="n">cake</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span>
            <span class="n">earth_model</span><span class="p">,</span> <span class="n">crust2_profile</span><span class="o">=</span><span class="n">profile_event</span><span class="p">)</span>

        <span class="c"># extract model for receiver stations,</span>
        <span class="c"># lowest layer has to be as well in source layer structure!</span>
        <span class="n">receiver_model</span> <span class="o">=</span> <span class="n">cake</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span>
            <span class="n">earth_model</span><span class="p">,</span> <span class="n">crust2_profile</span><span class="o">=</span><span class="n">profile_station</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">global_model</span> <span class="o">=</span> <span class="n">cake</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">earth_model</span><span class="p">)</span>
        <span class="n">source_model</span> <span class="o">=</span> <span class="n">utility</span><span class="o">.</span><span class="n">join_models</span><span class="p">(</span>
            <span class="n">global_model</span><span class="p">,</span> <span class="n">custom_velocity_model</span><span class="p">)</span>

        <span class="n">receiver_model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">source_model</span><span class="p">)</span>

    <span class="c"># randomly vary receiver site crustal model</span>
    <span class="k">if</span> <span class="n">crust_ind</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c">#moho_depth = receiver_model.discontinuity(&#39;moho&#39;).z</span>
        <span class="n">receiver_model</span> <span class="o">=</span> <span class="n">ensemble_earthmodel</span><span class="p">(</span>
            <span class="n">receiver_model</span><span class="p">,</span>
            <span class="n">num_vary</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">err_depth</span><span class="o">=</span><span class="n">err_depth</span><span class="p">,</span>
            <span class="n">err_velocities</span><span class="o">=</span><span class="n">err_velocities</span><span class="p">,</span>
            <span class="n">depth_limit_variation</span><span class="o">=</span><span class="n">depth_limit_variation</span> <span class="o">*</span> <span class="n">km</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c"># define phases</span>
    <span class="n">tabulated_phases</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">gf</span><span class="o">.</span><span class="n">TPDef</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="s">&#39;any_P&#39;</span><span class="p">,</span>
            <span class="n">definition</span><span class="o">=</span><span class="s">&#39;p,P,p</span><span class="se">\\</span><span class="s">,P</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">),</span>
        <span class="n">gf</span><span class="o">.</span><span class="n">TPDef</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="s">&#39;any_S&#39;</span><span class="p">,</span>
            <span class="n">definition</span><span class="o">=</span><span class="s">&#39;s,S,s</span><span class="se">\\</span><span class="s">,S</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">)]</span>

    <span class="c"># fill config files for fomosto</span>
    <span class="n">fom_conf</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">ConfigTypeA</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">_</span><span class="si">%.3f</span><span class="s">Hz_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">station</span><span class="o">.</span><span class="n">station</span><span class="p">,</span>
                        <span class="n">earth_model</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">sample_rate</span><span class="p">,</span>
                        <span class="n">crust_ind</span><span class="p">),</span>
        <span class="n">ncomponents</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">sample_rate</span><span class="o">=</span><span class="n">sample_rate</span><span class="p">,</span>
        <span class="n">receiver_depth</span><span class="o">=</span><span class="mf">0.</span> <span class="o">*</span> <span class="n">km</span><span class="p">,</span>
        <span class="n">source_depth_min</span><span class="o">=</span><span class="n">source_depth_min</span> <span class="o">*</span> <span class="n">km</span><span class="p">,</span>
        <span class="n">source_depth_max</span><span class="o">=</span><span class="n">source_depth_max</span> <span class="o">*</span> <span class="n">km</span><span class="p">,</span>
        <span class="n">source_depth_delta</span><span class="o">=</span><span class="n">source_depth_spacing</span> <span class="o">*</span> <span class="n">km</span><span class="p">,</span>
        <span class="n">distance_min</span><span class="o">=</span><span class="n">distance</span> <span class="o">-</span> <span class="p">(</span><span class="n">source_distance_radius</span> <span class="o">*</span> <span class="n">km</span><span class="p">),</span>
        <span class="n">distance_max</span><span class="o">=</span><span class="n">distance</span> <span class="o">+</span> <span class="p">(</span><span class="n">source_distance_radius</span> <span class="o">*</span> <span class="n">km</span><span class="p">),</span>
        <span class="n">distance_delta</span><span class="o">=</span><span class="n">source_distance_spacing</span> <span class="o">*</span> <span class="n">km</span><span class="p">,</span>
        <span class="n">tabulated_phases</span><span class="o">=</span><span class="n">tabulated_phases</span><span class="p">)</span>

   <span class="c"># slowness taper</span>
    <span class="n">phases</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">fom_conf</span><span class="o">.</span><span class="n">tabulated_phases</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">phases</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span>
            <span class="n">fom_conf</span><span class="o">.</span><span class="n">tabulated_phases</span><span class="p">))]</span>

    <span class="n">all_phases</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nb">map</span><span class="p">(</span><span class="n">all_phases</span><span class="o">.</span><span class="n">extend</span><span class="p">,</span> <span class="n">phases</span><span class="p">)</span>

    <span class="n">mean_source_depth</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">source_depth_min</span><span class="p">,</span> <span class="n">source_depth_max</span><span class="p">))</span>
    <span class="n">distances</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">fom_conf</span><span class="o">.</span><span class="n">distance_min</span><span class="p">,</span>
                             <span class="n">fom_conf</span><span class="o">.</span><span class="n">distance_max</span><span class="p">,</span>
                             <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">cake</span><span class="o">.</span><span class="n">m2d</span>

    <span class="n">arrivals</span> <span class="o">=</span> <span class="n">receiver_model</span><span class="o">.</span><span class="n">arrivals</span><span class="p">(</span>
                            <span class="n">phases</span><span class="o">=</span><span class="n">all_phases</span><span class="p">,</span>
                            <span class="n">distances</span><span class="o">=</span><span class="n">distances</span><span class="p">,</span>
                            <span class="n">zstart</span><span class="o">=</span><span class="n">mean_source_depth</span><span class="p">)</span>

    <span class="n">ps</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span><span class="n">arrivals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">p</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arrivals</span><span class="p">))])</span>

    <span class="n">slownesses</span> <span class="o">=</span> <span class="n">ps</span> <span class="o">/</span> <span class="p">(</span><span class="n">cake</span><span class="o">.</span><span class="n">r2d</span> <span class="o">*</span> <span class="n">cake</span><span class="o">.</span><span class="n">d2m</span> <span class="o">/</span> <span class="n">km</span><span class="p">)</span>

    <span class="n">slowness_taper</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span>
                      <span class="mf">0.0</span><span class="p">,</span>
                      <span class="mf">1.1</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">slownesses</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>
                      <span class="mf">1.3</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">slownesses</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>

    <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="s">&#39;qseis&#39;</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">pyrocko.fomosto.qseis</span> <span class="kn">import</span> <span class="n">build</span>
        <span class="n">receiver_model</span> <span class="o">=</span> <span class="n">receiver_model</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">depth_max</span><span class="o">=</span><span class="mi">200</span> <span class="o">*</span> <span class="n">km</span><span class="p">)</span>
        <span class="n">model_code_id</span> <span class="o">=</span> <span class="n">code</span>
        <span class="n">version</span> <span class="o">=</span> <span class="s">&#39;2006a&#39;</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="n">qseis</span><span class="o">.</span><span class="n">QSeisConfig</span><span class="p">(</span>
            <span class="n">filter_shallow_paths</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">slowness_window</span><span class="o">=</span><span class="n">slowness_taper</span><span class="p">,</span>
            <span class="n">wavelet_duration_samples</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
            <span class="n">sw_flat_earth_transform</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">sw_algorithm</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">qseis_version</span><span class="o">=</span><span class="n">version</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="s">&#39;qssp&#39;</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">pyrocko.fomosto.qssp</span> <span class="kn">import</span> <span class="n">build</span>
        <span class="n">source_model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">receiver_model</span><span class="p">)</span>
        <span class="n">receiver_model</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">model_code_id</span> <span class="o">=</span> <span class="n">code</span>
        <span class="n">version</span> <span class="o">=</span> <span class="s">&#39;2010beta&#39;</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="n">qssp</span><span class="o">.</span><span class="n">QSSPConfig</span><span class="p">(</span>
            <span class="n">qssp_version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span>
            <span class="n">slowness_max</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">slowness_taper</span><span class="p">)),</span>
            <span class="n">toroidal_modes</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">spheroidal_modes</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">source_patch_radius</span><span class="o">=</span><span class="p">(</span><span class="n">fom_conf</span><span class="o">.</span><span class="n">distance_delta</span> <span class="o">-</span> \
                                 <span class="n">fom_conf</span><span class="o">.</span><span class="n">distance_delta</span> <span class="o">*</span> <span class="mf">0.05</span><span class="p">)</span> <span class="o">/</span> <span class="n">km</span><span class="p">)</span>

    <span class="c">## elif code == &#39;QSEIS2d&#39;:</span>
    <span class="c">##     from pyrocko.fomosto.qseis2d import build</span>
    <span class="c">##     model_code_id = &#39;qseis2d&#39;</span>
    <span class="c">##     version = &#39;2014&#39;</span>
    <span class="c">##     conf = qseis2d.QSeis2dConfig()</span>
    <span class="c">##     conf.qseis_s_config.slowness_window = slowness_taper</span>
    <span class="c">##     conf.qseis_s_config.calc_slowness_window = 0</span>
    <span class="c">##     conf.qseis_s_config.receiver_max_distance = 11000.</span>
    <span class="c">##     conf.qseis_s_config.receiver_basement_depth = 35.</span>
    <span class="c">##     conf.qseis_s_config.sw_flat_earth_transform = 1</span>
    <span class="c">##     # extract method still buggy!!!</span>
    <span class="c">##     receiver_model = receiver_model.extract(</span>
    <span class="c">##             depth_max=conf.qseis_s_config.receiver_basement_depth * km)</span>

    <span class="c"># fill remaining fomosto params</span>
    <span class="n">fom_conf</span><span class="o">.</span><span class="n">earthmodel_1d</span> <span class="o">=</span> <span class="n">source_model</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">depth_max</span><span class="o">=</span><span class="s">&#39;cmb&#39;</span><span class="p">)</span>
    <span class="n">fom_conf</span><span class="o">.</span><span class="n">earthmodel_receiver_1d</span> <span class="o">=</span> <span class="n">receiver_model</span>
    <span class="n">fom_conf</span><span class="o">.</span><span class="n">modelling_code_id</span> <span class="o">=</span> <span class="n">model_code_id</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">version</span>

    <span class="n">window_extension</span> <span class="o">=</span> <span class="mf">60.</span>   <span class="c"># [s]</span>

    <span class="n">conf</span><span class="o">.</span><span class="n">time_region</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">gf</span><span class="o">.</span><span class="n">Timing</span><span class="p">(</span><span class="n">tabulated_phases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s">&#39;-</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">1.1</span> <span class="o">*</span> <span class="n">window_extension</span><span class="p">)),</span>
        <span class="n">gf</span><span class="o">.</span><span class="n">Timing</span><span class="p">(</span><span class="n">tabulated_phases</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s">&#39;+</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">1.6</span> <span class="o">*</span> <span class="n">window_extension</span><span class="p">)))</span>

    <span class="n">conf</span><span class="o">.</span><span class="n">cut</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">gf</span><span class="o">.</span><span class="n">Timing</span><span class="p">(</span><span class="n">tabulated_phases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s">&#39;-</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">window_extension</span><span class="p">),</span>
        <span class="n">gf</span><span class="o">.</span><span class="n">Timing</span><span class="p">(</span><span class="n">tabulated_phases</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s">&#39;+</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">1.5</span> <span class="o">*</span> <span class="n">window_extension</span><span class="p">)))</span>

    <span class="n">conf</span><span class="o">.</span><span class="n">relevel_with_fade_in</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">conf</span><span class="o">.</span><span class="n">fade</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">gf</span><span class="o">.</span><span class="n">Timing</span><span class="p">(</span><span class="n">tabulated_phases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s">&#39;-</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">1.1</span> <span class="o">*</span> <span class="n">window_extension</span><span class="p">)),</span>
        <span class="n">gf</span><span class="o">.</span><span class="n">Timing</span><span class="p">(</span><span class="n">tabulated_phases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s">&#39;-</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">window_extension</span><span class="p">),</span>
        <span class="n">gf</span><span class="o">.</span><span class="n">Timing</span><span class="p">(</span><span class="n">tabulated_phases</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s">&#39;+</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">1.5</span> <span class="o">*</span> <span class="n">window_extension</span><span class="p">)),</span>
        <span class="n">gf</span><span class="o">.</span><span class="n">Timing</span><span class="p">(</span><span class="n">tabulated_phases</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s">&#39;+</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">1.6</span> <span class="o">*</span> <span class="n">window_extension</span><span class="p">)))</span>

    <span class="n">fom_conf</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
    <span class="n">conf</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

    <span class="n">store_dir</span> <span class="o">=</span> <span class="n">store_superdir</span> <span class="o">+</span> <span class="n">fom_conf</span><span class="o">.</span><span class="n">id</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Creating Store at </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">store_dir</span><span class="p">)</span>
    <span class="n">gf</span><span class="o">.</span><span class="n">Store</span><span class="o">.</span><span class="n">create_editables</span><span class="p">(</span><span class="n">store_dir</span><span class="p">,</span>
                              <span class="n">config</span><span class="o">=</span><span class="n">fom_conf</span><span class="p">,</span>
                              <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="n">model_code_id</span><span class="p">:</span> <span class="n">conf</span><span class="p">},</span>
                              <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">execute</span><span class="p">:</span>
        <span class="n">store</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">Store</span><span class="p">(</span><span class="n">store_dir</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">store</span><span class="o">.</span><span class="n">make_ttt</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>
        <span class="n">store</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">build</span><span class="p">(</span><span class="n">store_dir</span><span class="p">,</span> <span class="n">nworkers</span><span class="o">=</span><span class="n">nworkers</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rm_gfs</span> <span class="ow">and</span> <span class="n">code</span> <span class="o">==</span> <span class="s">&#39;qssp&#39;</span><span class="p">:</span>
            <span class="n">gf_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">store_dir</span><span class="p">,</span> <span class="s">&#39;qssp_green&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Removing QSSP Greens Functions!&#39;</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">gf_dir</span><span class="p">)</span></div>


<div class="viewcode-block" id="geo_construct_gf"><a class="viewcode-back" href="../api.html#heart.geo_construct_gf">[docs]</a><span class="k">def</span> <span class="nf">geo_construct_gf</span><span class="p">(</span>
        <span class="n">event</span><span class="p">,</span> <span class="n">store_superdir</span><span class="p">,</span>
        <span class="n">source_distance_min</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">source_distance_max</span><span class="o">=</span><span class="mf">100.</span><span class="p">,</span>
        <span class="n">source_depth_min</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">source_depth_max</span><span class="o">=</span><span class="mf">40.</span><span class="p">,</span>
        <span class="n">source_distance_spacing</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span> <span class="n">source_depth_spacing</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">sampling_interval</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
        <span class="n">earth_model</span><span class="o">=</span><span class="s">&#39;ak135-f-average.m&#39;</span><span class="p">,</span> <span class="n">crust_ind</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">replace_water</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">use_crust2</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">custom_velocity_model</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">execute</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate geodetic Greens Functions (GFs) and create a repository &#39;store&#39;</span>
<span class="sd">    that is being used later on repeatetly to calculate the synthetic</span>
<span class="sd">    displacements.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    event : :class:`pyrocko.model.Event`</span>
<span class="sd">        The event is used as a reference point for all the calculations</span>
<span class="sd">        According to the its location the earth model is being built</span>
<span class="sd">    store_superdir : str</span>
<span class="sd">        Path to the main directory where all the GF stores are stored</span>
<span class="sd">    source_distance_min : scalar, float</span>
<span class="sd">        Lower bound [km] for the source-distance grid of GFs to calculate</span>
<span class="sd">    source_distance_max : scalar, float</span>
<span class="sd">        Upper bound [km] for the source-distance grid of GFs to calculate</span>
<span class="sd">    source_distance_spacing : scalar, float</span>
<span class="sd">        Spacing [km] for the source-distance grid of GFs to calculate</span>
<span class="sd">    source_depth_min : scalar, float</span>
<span class="sd">        Lower bound [km] for the source-depth grid of GFs to calculate</span>
<span class="sd">    source_depth_max : scalar, float</span>
<span class="sd">        Upper bound [km] for the source-depth grid of GFs to calculate</span>
<span class="sd">    source_depth_spacing : scalar, float</span>
<span class="sd">        Spacing [km] for the source-depth grid of GFs to calculate</span>
<span class="sd">    sampling_interval : scalar, float &gt;= 1.</span>
<span class="sd">        Source-distance dependend sampling density of grid points, if == 1</span>
<span class="sd">        linear distance sampling, if &gt; 1. exponentially decreasing sampling</span>
<span class="sd">        with increasing distance</span>
<span class="sd">    earth_model : str</span>
<span class="sd">        Name of the base earth model to be used, check</span>
<span class="sd">        :func:`pyrocko.cake.builtin_models` for alternatives,</span>
<span class="sd">        default ak135 with medium resolution</span>
<span class="sd">    crust_ind : int</span>
<span class="sd">        Index to set to the Greens Function store</span>
<span class="sd">    replace_water : boolean</span>
<span class="sd">        Flag to remove water layers from the crust2.0 profile</span>
<span class="sd">    use_crust2 : boolean</span>
<span class="sd">        Flag to use the crust2.0 model for the crustal earth model</span>
<span class="sd">    custom_velocity_model : :class:`pyrocko.cake.LayeredModel`</span>
<span class="sd">        If the implemented velocity models should not be used, a custom</span>
<span class="sd">        velocity model can be given here</span>
<span class="sd">    execute : boolean</span>
<span class="sd">        Flag to execute the calculation, if False just setup tested</span>
<span class="sd">    force : boolean</span>
<span class="sd">        Flag to overwrite existing GF stores</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">c</span> <span class="o">=</span> <span class="n">psgrn</span><span class="o">.</span><span class="n">PsGrnConfigFull</span><span class="p">()</span>

    <span class="n">n_steps_depth</span> <span class="o">=</span> <span class="p">(</span><span class="n">source_depth_max</span> <span class="o">-</span> <span class="n">source_depth_min</span><span class="p">)</span> <span class="o">/</span> \
        <span class="n">source_depth_spacing</span>
    <span class="n">n_steps_distance</span> <span class="o">=</span> <span class="p">(</span><span class="n">source_distance_max</span> <span class="o">-</span> <span class="n">source_distance_min</span><span class="p">)</span> <span class="o">/</span> \
        <span class="n">source_distance_spacing</span>

    <span class="n">c</span><span class="o">.</span><span class="n">distance_grid</span> <span class="o">=</span> <span class="n">psgrn</span><span class="o">.</span><span class="n">PsGrnSpatialSampling</span><span class="p">(</span>
        <span class="n">n_steps</span><span class="o">=</span><span class="n">n_steps_distance</span><span class="p">,</span>
        <span class="n">start_distance</span><span class="o">=</span><span class="n">source_distance_min</span><span class="p">,</span>
        <span class="n">end_distance</span><span class="o">=</span><span class="n">source_distance_max</span><span class="p">)</span>

    <span class="n">c</span><span class="o">.</span><span class="n">depth_grid</span> <span class="o">=</span> <span class="n">psgrn</span><span class="o">.</span><span class="n">PsGrnSpatialSampling</span><span class="p">(</span>
        <span class="n">n_steps</span><span class="o">=</span><span class="n">n_steps_depth</span><span class="p">,</span>
        <span class="n">start_distance</span><span class="o">=</span><span class="n">source_depth_min</span><span class="p">,</span>
        <span class="n">end_distance</span><span class="o">=</span><span class="n">source_depth_max</span><span class="p">)</span>

    <span class="n">c</span><span class="o">.</span><span class="n">sampling_interval</span> <span class="o">=</span> <span class="n">sampling_interval</span>

    <span class="c"># extract source crustal profile and check for water layer</span>
    <span class="k">if</span> <span class="n">use_crust2</span><span class="p">:</span>
        <span class="n">source_profile</span> <span class="o">=</span> <span class="n">crust2x2</span><span class="o">.</span><span class="n">get_profile</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">lon</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">replace_water</span><span class="p">:</span>
            <span class="n">thickness_lwater</span> <span class="o">=</span> <span class="n">source_profile</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="n">crust2x2</span><span class="o">.</span><span class="n">LWATER</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">thickness_lwater</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Water layer </span><span class="si">%f</span><span class="s"> in CRUST model! &#39;</span>
                        <span class="s">&#39;Remove and add to lower crust&#39;</span> <span class="o">%</span> <span class="n">thickness_lwater</span><span class="p">)</span>

                <span class="n">thickness_llowercrust</span> <span class="o">=</span> <span class="n">source_profile</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span>
                                        <span class="n">crust2x2</span><span class="o">.</span><span class="n">LLOWERCRUST</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">source_profile</span><span class="o">.</span><span class="n">set_layer_thickness</span><span class="p">(</span><span class="n">crust2x2</span><span class="o">.</span><span class="n">LWATER</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="n">source_profile</span><span class="o">.</span><span class="n">set_layer_thickness</span><span class="p">(</span>
                    <span class="n">crust2x2</span><span class="o">.</span><span class="n">LLOWERCRUST</span><span class="p">,</span>
                    <span class="n">thickness_llowercrust</span> <span class="o">+</span> <span class="n">thickness_lwater</span><span class="p">)</span>

                <span class="n">source_profile</span><span class="o">.</span><span class="n">_elevation</span> <span class="o">=</span> <span class="mf">0.0</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;New Lower crust layer thickness </span><span class="si">%f</span><span class="s">&#39;</span> <span class="o">%</span> \
                    <span class="n">source_profile</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="n">crust2x2</span><span class="o">.</span><span class="n">LLOWERCRUST</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">source_model</span> <span class="o">=</span> <span class="n">cake</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span>
            <span class="n">earth_model</span><span class="p">,</span>
            <span class="n">crust2_profile</span><span class="o">=</span><span class="n">source_profile</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span>
                <span class="n">depth_max</span><span class="o">=</span><span class="n">source_depth_max</span> <span class="o">*</span> <span class="n">km</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">custom_velocity_model</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;custom velocity model not given!&#39;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Using custom model from config file&#39;</span><span class="p">)</span>
        <span class="n">source_model</span> <span class="o">=</span> <span class="n">custom_velocity_model</span>

    <span class="c"># potentially vary source model</span>
    <span class="k">if</span> <span class="n">crust_ind</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">source_model</span> <span class="o">=</span> <span class="n">ensemble_earthmodel</span><span class="p">(</span>
            <span class="n">source_model</span><span class="p">,</span>
            <span class="n">num_vary</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">err_depth</span><span class="o">=</span><span class="n">err_depth</span><span class="p">,</span>
            <span class="n">err_velocities</span><span class="o">=</span><span class="n">err_velocities</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">c</span><span class="o">.</span><span class="n">earthmodel_1d</span> <span class="o">=</span> <span class="n">source_model</span>
    <span class="n">c</span><span class="o">.</span><span class="n">psgrn_outdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">store_superdir</span><span class="p">,</span> <span class="s">&#39;psgrn_green_</span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">crust_ind</span><span class="p">))</span>
    <span class="n">c</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

    <span class="n">util</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">psgrn_outdir</span><span class="p">)</span>

    <span class="n">runner</span> <span class="o">=</span> <span class="n">psgrn</span><span class="o">.</span><span class="n">PsGrnRunner</span><span class="p">(</span><span class="n">outdir</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">psgrn_outdir</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">execute</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Geo GFs can be created in directory: </span><span class="si">%s</span><span class="s"> ! &#39;</span>
                    <span class="s">&#39;(execute=True necessary)! GF params: </span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">c</span><span class="o">.</span><span class="n">psgrn_outdir</span><span class="p">)</span>
        <span class="k">print</span> <span class="n">c</span>

    <span class="k">if</span> <span class="n">execute</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Creating Geo GFs in directory: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">c</span><span class="o">.</span><span class="n">psgrn_outdir</span><span class="p">)</span>
        <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">force</span><span class="p">)</span></div>


<div class="viewcode-block" id="geo_layer_synthetics"><a class="viewcode-back" href="../api.html#heart.geo_layer_synthetics">[docs]</a><span class="k">def</span> <span class="nf">geo_layer_synthetics</span><span class="p">(</span><span class="n">store_superdir</span><span class="p">,</span> <span class="n">crust_ind</span><span class="p">,</span> <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span>
                         <span class="n">keep_tmp</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate synthetic displacements for a given Greens Function database</span>
<span class="sd">    sources and observation points on the earths surface.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    store_superdir : str</span>
<span class="sd">        main path to directory containing the different Greensfunction stores</span>
<span class="sd">    crust_ind : int</span>
<span class="sd">        index of Greens Function store to use</span>
<span class="sd">    lons : List of floats</span>
<span class="sd">        Longitudes [decimal deg] of observation points</span>
<span class="sd">    lats : List of floats</span>
<span class="sd">        Latitudes [decimal deg] of observation points</span>
<span class="sd">    sources : List of :class:`pscmp.PsCmpRectangularSource`</span>
<span class="sd">        Sources i.e. faults to calculate synthetics for</span>
<span class="sd">    keep_tmp : boolean</span>
<span class="sd">        Flag to keep directories (in &#39;/tmp&#39;) where calculated synthetics are</span>
<span class="sd">        stored.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :class:`numpy.ndarray` (n_observations; ux, uy, uz)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">c</span> <span class="o">=</span> <span class="n">pscmp</span><span class="o">.</span><span class="n">PsCmpConfigFull</span><span class="p">()</span>
    <span class="n">c</span><span class="o">.</span><span class="n">observation</span> <span class="o">=</span> <span class="n">pscmp</span><span class="o">.</span><span class="n">PsCmpScatter</span><span class="p">(</span><span class="n">lats</span><span class="o">=</span><span class="n">lats</span><span class="p">,</span> <span class="n">lons</span><span class="o">=</span><span class="n">lons</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">psgrn_outdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">store_superdir</span><span class="p">,</span> <span class="s">&#39;psgrn_green_</span><span class="si">%i</span><span class="s">/&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">crust_ind</span><span class="p">))</span>

    <span class="c"># only coseismic displacement</span>
    <span class="n">c</span><span class="o">.</span><span class="n">times_snapshots</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">c</span><span class="o">.</span><span class="n">rectangular_source_patches</span> <span class="o">=</span> <span class="n">sources</span>

    <span class="n">runner</span> <span class="o">=</span> <span class="n">pscmp</span><span class="o">.</span><span class="n">PsCmpRunner</span><span class="p">(</span><span class="n">keep_tmp</span><span class="o">=</span><span class="n">keep_tmp</span><span class="p">)</span>
    <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="c"># returns list of displacements for each snapshot</span>
    <span class="k">return</span> <span class="n">runner</span><span class="o">.</span><span class="n">get_results</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s">&#39;displ&#39;</span><span class="p">,</span> <span class="n">flip_z</span><span class="o">=</span><span class="bp">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="get_phase_arrival_time"><a class="viewcode-back" href="../api.html#heart.get_phase_arrival_time">[docs]</a><span class="k">def</span> <span class="nf">get_phase_arrival_time</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get arrival time from Greens Function store for respective</span>
<span class="sd">    :class:`pyrocko.gf.seismosizer.Target`,</span>
<span class="sd">    :class:`pyrocko.gf.meta.Location` pair. The channel of the target</span>
<span class="sd">    determines if S or P wave arrival time is returned.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    engine : :class:`pyrocko.gf.seismosizer.LocalEngine`</span>
<span class="sd">    source : :class:`pyrocko.gf.meta.Location`</span>
<span class="sd">        can be therefore :class:`pyrocko.gf.seismosizer.Source` or</span>
<span class="sd">        :class:`pyrocko.model.Event`</span>
<span class="sd">    target : :class:`pyrocko.gf.seismosizer.Target`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    scalar, float of the arrival time of the wave</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">store</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">get_store</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">store_id</span><span class="p">)</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">distance_to</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">depth</span>
    <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">codes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;T&#39;</span><span class="p">:</span>
        <span class="n">wave</span> <span class="o">=</span> <span class="s">&#39;any_S&#39;</span>
    <span class="k">elif</span> <span class="n">target</span><span class="o">.</span><span class="n">codes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;Z&#39;</span><span class="p">:</span>
        <span class="n">wave</span> <span class="o">=</span> <span class="s">&#39;any_P&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Channel not supported! Either: &quot;T&quot; or &quot;Z&quot;&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">store</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">dist</span><span class="p">))</span> <span class="o">+</span> <span class="n">source</span><span class="o">.</span><span class="n">time</span></div>


<div class="viewcode-block" id="get_phase_taperer"><a class="viewcode-back" href="../api.html#heart.get_phase_taperer">[docs]</a><span class="k">def</span> <span class="nf">get_phase_taperer</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">arrival_taper</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create phase taperer according to synthetic travel times from</span>
<span class="sd">    source- target pair and taper return :class:`pyrocko.trace.CosTaper`</span>
<span class="sd">    according to defined arrival_taper times.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    engine : :class:`pyrocko.gf.seismosizer.LocalEngine`</span>
<span class="sd">    source : :class:`pyrocko.gf.meta.Location`</span>
<span class="sd">        can be therefore :class:`pyrocko.gf.seismosizer.Source` or</span>
<span class="sd">        :class:`pyrocko.model.Event`</span>
<span class="sd">    target : :class:`pyrocko.gf.seismosizer.Target`</span>
<span class="sd">    arrival_taper : :class:`ArrivalTaper`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :class:`pyrocko.trace.CosTaper`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">arrival_time</span> <span class="o">=</span> <span class="n">get_phase_arrival_time</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

    <span class="n">taperer</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">CosTaper</span><span class="p">(</span><span class="n">arrival_time</span> <span class="o">+</span> <span class="n">arrival_taper</span><span class="o">.</span><span class="n">a</span><span class="p">,</span>
                             <span class="n">arrival_time</span> <span class="o">+</span> <span class="n">arrival_taper</span><span class="o">.</span><span class="n">b</span><span class="p">,</span>
                             <span class="n">arrival_time</span> <span class="o">+</span> <span class="n">arrival_taper</span><span class="o">.</span><span class="n">c</span><span class="p">,</span>
                             <span class="n">arrival_time</span> <span class="o">+</span> <span class="n">arrival_taper</span><span class="o">.</span><span class="n">d</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">taperer</span></div>


<div class="viewcode-block" id="seis_synthetics"><a class="viewcode-back" href="../api.html#heart.seis_synthetics">[docs]</a><span class="k">def</span> <span class="nf">seis_synthetics</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">arrival_taper</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">filterer</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">reference_taperer</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                    <span class="n">nprocs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">outmode</span><span class="o">=</span><span class="s">&#39;array&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate synthetic seismograms of combination of targets and sources,</span>
<span class="sd">    filtering and tapering afterwards (filterer)</span>
<span class="sd">    tapering according to arrival_taper around P -or S wave.</span>
<span class="sd">    If reference_taper the given taper is always used.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    engine : :class:`pyrocko.gf.seismosizer.LocalEngine`</span>
<span class="sd">    sources : List</span>
<span class="sd">        containing :class:`pyrocko.gf.seismosizer.Source` Objects</span>
<span class="sd">    targets : List</span>
<span class="sd">        containing :class:`pyrocko.gf.seismosizer.Target` Objects</span>
<span class="sd">    arrival_taper : :class:`ArrivalTaper`</span>
<span class="sd">    filterer : :class:`Filterer`</span>
<span class="sd">    reference_taperer : :class:`ArrivalTaper`</span>
<span class="sd">        if set all the traces are tapered with the specifications of this Taper</span>
<span class="sd">    plot : boolean</span>
<span class="sd">        flag for looking at traces</span>
<span class="sd">    nprocs : int</span>
<span class="sd">        number of processors to use for synthetics calculation</span>
<span class="sd">    outmode : string</span>
<span class="sd">        output format of synthetics can be &#39;array&#39;, &#39;traces&#39;,</span>
<span class="sd">        &#39;data&#39; returns traces unstacked including post-processing</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :class:`numpy.ndarray` or List of :class:`pyrocko.trace.Trace`</span>
<span class="sd">         with data each row-one target</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">sources</span><span class="o">=</span><span class="n">sources</span><span class="p">,</span>
                              <span class="n">targets</span><span class="o">=</span><span class="n">targets</span><span class="p">,</span> <span class="n">nprocs</span><span class="o">=</span><span class="n">nprocs</span><span class="p">)</span>

    <span class="n">synt_trcs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">iter_results</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">arrival_taper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">reference_taperer</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">taperer</span> <span class="o">=</span> <span class="n">get_phase_taperer</span><span class="p">(</span>
                    <span class="n">engine</span><span class="p">,</span>
                    <span class="n">sources</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">target</span><span class="p">,</span>
                    <span class="n">arrival_taper</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">taperer</span> <span class="o">=</span> <span class="n">reference_taperer</span>

            <span class="c"># cut traces</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">taper</span><span class="p">(</span><span class="n">taperer</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">chop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filterer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># filter traces</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">bandpass</span><span class="p">(</span><span class="n">corner_hp</span><span class="o">=</span><span class="n">filterer</span><span class="o">.</span><span class="n">lower_corner</span><span class="p">,</span>
                    <span class="n">corner_lp</span><span class="o">=</span><span class="n">filterer</span><span class="o">.</span><span class="n">upper_corner</span><span class="p">,</span>
                    <span class="n">order</span><span class="o">=</span><span class="n">filterer</span><span class="o">.</span><span class="n">order</span><span class="p">)</span>

        <span class="n">synt_trcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">trace</span><span class="o">.</span><span class="n">snuffle</span><span class="p">(</span><span class="n">synt_trcs</span><span class="p">)</span>

    <span class="n">nt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="n">ns</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span>

    <span class="n">tmins</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">synt_trcs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tmin</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">)])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">arrival_taper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">synths</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
            <span class="p">[</span><span class="n">synt_trcs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">ydata</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">synt_trcs</span><span class="p">))])</span>

        <span class="c"># stack traces for all sources</span>
        <span class="k">if</span> <span class="n">ns</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ns</span><span class="p">):</span>
                <span class="n">outstack</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nt</span><span class="p">,</span> <span class="n">synths</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                <span class="n">outstack</span> <span class="o">+=</span> <span class="n">synths</span><span class="p">[(</span><span class="n">k</span> <span class="o">*</span> <span class="n">nt</span><span class="p">):(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">nt</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outstack</span> <span class="o">=</span> <span class="n">synths</span>

    <span class="k">if</span> <span class="n">outmode</span> <span class="o">==</span> <span class="s">&#39;traces&#39;</span><span class="p">:</span>
        <span class="n">outstack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">):</span>
            <span class="n">synt_trcs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">outstack</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">outstack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">synt_trcs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">outstack</span><span class="p">,</span> <span class="n">tmins</span>

    <span class="k">elif</span> <span class="n">outmode</span> <span class="o">==</span> <span class="s">&#39;data&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">synt_trcs</span><span class="p">,</span> <span class="n">tmins</span>

    <span class="k">elif</span> <span class="n">outmode</span> <span class="o">==</span> <span class="s">&#39;array&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">outstack</span><span class="p">,</span> <span class="n">tmins</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Outmode </span><span class="si">%s</span><span class="s"> not supported!&#39;</span> <span class="o">%</span> <span class="n">outmode</span><span class="p">)</span></div>


<div class="viewcode-block" id="taper_filter_traces"><a class="viewcode-back" href="../api.html#heart.taper_filter_traces">[docs]</a><span class="k">def</span> <span class="nf">taper_filter_traces</span><span class="p">(</span><span class="n">data_traces</span><span class="p">,</span> <span class="n">arrival_taper</span><span class="p">,</span> <span class="n">filterer</span><span class="p">,</span> <span class="n">tmins</span><span class="p">,</span>
                        <span class="n">plot</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Taper and filter data_traces according to given taper and filterers.</span>
<span class="sd">    Tapering will start at the given tmin.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data_traces : List</span>
<span class="sd">        containing :class:`pyrocko.trace.Trace` objects</span>
<span class="sd">    arrival_taper : :class:`ArrivalTaper`</span>
<span class="sd">    filterer : :class:`Filterer`</span>
<span class="sd">    tmins : :class:`numpy.ndarray`</span>
<span class="sd">        Array containing the start times [s] since 1st.January 1970 to start</span>
<span class="sd">        tapering</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :class:`numpy.ndarray`</span>
<span class="sd">        with tapered and filtered data traces, rows different traces,</span>
<span class="sd">        columns temporal values</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cut_traces</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_traces</span><span class="p">):</span>
        <span class="n">cut_trace</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">arrival_taper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">taperer</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">CosTaper</span><span class="p">(</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">tmins</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">tmins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">arrival_taper</span><span class="o">.</span><span class="n">b</span><span class="p">),</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">tmins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">arrival_taper</span><span class="o">.</span><span class="n">a</span> <span class="o">+</span> <span class="n">arrival_taper</span><span class="o">.</span><span class="n">c</span><span class="p">),</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">tmins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">arrival_taper</span><span class="o">.</span><span class="n">a</span> <span class="o">+</span> <span class="n">arrival_taper</span><span class="o">.</span><span class="n">d</span><span class="p">))</span>

            <span class="c"># taper and cut traces</span>
            <span class="n">cut_trace</span><span class="o">.</span><span class="n">taper</span><span class="p">(</span><span class="n">taperer</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">chop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filterer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># filter traces</span>
            <span class="n">cut_trace</span><span class="o">.</span><span class="n">bandpass</span><span class="p">(</span><span class="n">corner_hp</span><span class="o">=</span><span class="n">filterer</span><span class="o">.</span><span class="n">lower_corner</span><span class="p">,</span>
                               <span class="n">corner_lp</span><span class="o">=</span><span class="n">filterer</span><span class="o">.</span><span class="n">upper_corner</span><span class="p">,</span>
                               <span class="n">order</span><span class="o">=</span><span class="n">filterer</span><span class="o">.</span><span class="n">order</span><span class="p">)</span>

        <span class="n">cut_traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cut_trace</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">trace</span><span class="o">.</span><span class="n">snuffle</span><span class="p">(</span><span class="n">cut_traces</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">cut_traces</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">ydata</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_traces</span><span class="p">))])</span></div>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Hannes Vasyura-Bathke.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>